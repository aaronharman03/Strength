<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Strength Progress Tracker</title>
  <link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#4caf50" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script type="module">
  async function loadUserExercises(uid) {
  const userExercisesRef = collection(firebase.db, "users", uid, "exercises");
  try {
    const snapshot = await getDocs(userExercisesRef);
    exercisesDiv.innerHTML = "";
    progressArray = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      const exerciseEl = createExerciseElement(data, data.progressPercent);
      exercisesDiv.appendChild(exerciseEl);
      progressArray.push(data.progressPercent);
    });

    updateOverallProgress();
  } catch (error) {
    console.error("Error loading exercises:", error);
  }
}

  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, doc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Make these available globally (optional)
  window.firebase = { auth, db };
</script>
<div id="auth-container">
  <h2>Login or Sign Up</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Sign In</button>
  <button onclick="signOutUser()">Sign Out</button>
  <p id="user-status"></p>
</div>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      background: #f9f9f9;
      color: #333;
    }
    h2 {
      border-bottom: 2px solid #4caf50;
      padding-bottom: 6px;
      margin-bottom: 20px;
    }
    h2 {
  text-align: center;
}

    form {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      position: relative;
    }
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    .form-row label {
      flex: 0 0 130px;
      font-weight: 600;
    }
    .form-row input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-row input:focus {
      border-color: #4caf50;
      outline: none;
    }
    .reps-group {
  display: flex;
  gap: 25px;
  justify-content: space-between;
}

.reps-group div {
  flex: 0 0 40px; /* fixed width of 40px */
  max-width: 40px;
}

.reps-group input {
  width: 150%;      /* Make input fill the div */
  box-sizing: border-box;
  padding: 8px 10px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border-color 0.2s;
}

    button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
    }
    button:hover {
      background: #3a8e3a;
    }
    .exercise {
      background: #fff;
      margin: 20px 0;
      border: 1px solid #ddd;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.05);
      position: relative;
    }
    .progress-bar {
      height: 20px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.3s;
    }
    /* Burger menu styles */
    .burger-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      user-select: none;
    }
    .menu {
      position: absolute;
      top: 40px;
      right: 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.15);
      display: none;
      z-index: 100;
      width: 100px;
    }
    .menu button {
      background: none;
      border: none;
      width: 100%;
      padding: 8px 10px;
      text-align: left;
      cursor: pointer;
      font-size: 0.9rem;
      color: #333;
      border-bottom: 1px solid #eee;
    }
    .menu button:last-child {
      border-bottom: none;
    }
    .menu button:hover {
      background: #4caf50;
      color: white;
    }
  </style>
</head>
<body>
    <h2>Overall Progress</h2>
<div class="progress-bar" id="overall-progress-bar" style="max-width: 600px; margin: 0 auto 30px;">
  <div class="progress-fill" style="width: 0%; background: #2196F3;"></div>
</div>

  <h2>Add Exercise</h2>
  <form id="exercise-form">
    <div class="form-row">
      <label for="name">Exercise Name</label>
      <input placeholder="Exercise name" id="name" required />
    </div>
    <div class="form-row">
      <label for="startWeight">Start Weight (kg)</label>
      <input type="number" step="0.1" id="startWeight" required />
    </div>
    <div class="form-row">
      <label for="goalWeight">Goal Weight (kg)</label>
      <input type="number" step="0.1" id="goalWeight" required />
    </div>
    <div class="form-row">
      <label for="currentWeight">Current Weight (kg)</label>
      <input type="number" step="0.1" id="currentWeight" required />
    </div>
    
    <div class="form-row">
      <label>Reps per Set</label>
      <div class="reps-group">
        <div><input placeholder="Set 1" type="number" id="reps1" required /></div>
        <div><input placeholder="Set 2" type="number" id="reps2" required /></div>
        <div><input placeholder="Set 3" type="number" id="reps3" required /></div>
      </div>
    </div>

    <div class="form-row">
      <label for="repRangeMin">Rep Range Min</label>
      <input type="number" id="repRangeMin" value="6" />
    </div>
    <div class="form-row">
      <label for="repRangeMax">Rep Range Max</label>
      <input type="number" id="repRangeMax" value="10" />
    </div>
    <div class="form-row">
      <label for="increment">Weight Increment (kg)</label>
      <input type="number" step="0.1" id="increment" value="2.5" />
    </div>
    <button type="submit" id="submit-btn">Add Exercise</button>
  </form>

  <h2>Progress</h2>
  <div id="exercises"></div>

  <script>
    const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const userStatus = document.getElementById("user-status");

function signUp() {
  createUserWithEmailAndPassword(firebase.auth, emailInput.value, passwordInput.value)
    .then(userCredential => {
      userStatus.textContent = `Signed up as ${userCredential.user.email}`;
    }).catch(error => alert(error.message));
}

function signIn() {
  signInWithEmailAndPassword(firebase.auth, emailInput.value, passwordInput.value)
    .then(userCredential => {
      userStatus.textContent = `Signed in as ${userCredential.user.email}`;
    }).catch(error => alert(error.message));
}

function signOutUser() {
  signOut(firebase.auth).then(() => {
    userStatus.textContent = "Signed out";
  });
}

onAuthStateChanged(firebase.auth, user => {
  if (user) {
    userStatus.textContent = `Logged in as ${user.email}`;
    loadUserExercises(user.uid);
  } else {
    userStatus.textContent = "Not logged in";
  }
});

    const form = document.getElementById("exercise-form");
    const exercisesDiv = document.getElementById("exercises");
    const submitBtn = document.getElementById("submit-btn");

    // Store currently edited exercise element and its data index
    let editingExercise = null;
const overallBarFill = document.querySelector('#overall-progress-bar .progress-fill');
let progressArray = []; // to store each exercise progress

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const data = {
        name: form.name.value.trim(),
        startWeight: parseFloat(form.startWeight.value),
        goalWeight: parseFloat(form.goalWeight.value),
        currentWeight: parseFloat(form.currentWeight.value),
        reps: [
          parseInt(form.reps1.value),
          parseInt(form.reps2.value),
          parseInt(form.reps3.value),
        ],
        repRangeMin: parseInt(form.repRangeMin.value),
        repRangeMax: parseInt(form.repRangeMax.value),
        increment: parseFloat(form.increment.value),
      };

      // Clamp reps
      data.reps = data.reps.map((r) =>
        Math.min(Math.max(r, data.repRangeMin), data.repRangeMax)
      );

      // Calculate progress
      const repIncrements = data.reps.map((r) => r - data.repRangeMin);
      const totalRepsIncrements = repIncrements.reduce((a, b) => a + b, 0);
      const maxRepsIncrementsPerWeight =
        (data.repRangeMax - data.repRangeMin) * 3;
      const weightIncrements = Math.floor(
        (data.currentWeight - data.startWeight) / data.increment
      );
      const maxWeightIncrements = Math.floor(
        (data.goalWeight - data.startWeight) / data.increment
      );
      const currentLevel =
        weightIncrements * (maxRepsIncrementsPerWeight + 1) +
        totalRepsIncrements +
        1;
      const maxLevel =
        maxWeightIncrements * (maxRepsIncrementsPerWeight + 1) +
        maxRepsIncrementsPerWeight +
        1;
      let progressPercent = (currentLevel / maxLevel) * 100;
      progressPercent = Math.min(100, Math.max(0, progressPercent));

      const progressPercentNum = progressPercent;
  progressArray.push(progressPercentNum);
  const avgProgress = progressArray.reduce((a, b) => a + b, 0) / progressArray.length;
  overallBarFill.style.width = avgProgress + '%';

      if (editingExercise) {
        // Update existing exercise element
        editingExercise.dataset.name = data.name;
        editingExercise.dataset.startWeight = data.startWeight;
        editingExercise.dataset.goalWeight = data.goalWeight;
        editingExercise.dataset.currentWeight = data.currentWeight;
        editingExercise.dataset.reps = data.reps.join(',');
        editingExercise.dataset.repRangeMin = data.repRangeMin;
        editingExercise.dataset.repRangeMax = data.repRangeMax;
        editingExercise.dataset.increment = data.increment;

        updateExerciseElement(editingExercise, data, progressPercent);

        editingExercise = null;
        submitBtn.textContent = "Add Exercise";
      } else {
        // Create new exercise element
        const exercise = createExerciseElement(data, progressPercent);
        exercisesDiv.appendChild(exercise);
      }
const user = firebase.auth.currentUser;
if (user) {
  const userExercisesRef = collection(firebase.db, "users", user.uid, "exercises");
  await addDoc(userExercisesRef, { ...data, progressPercent });
}

      form.reset();
    });
    if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(registration => {
        console.log('Service Worker registered with scope:', registration.scope);
      })
      .catch(error => {
        console.error('Service Worker registration failed:', error);
      });
  });
}


    // Creates exercise DOM element with burger menu
    function createExerciseElement(data, progressPercent) {
      const exercise = document.createElement("div");
      exercise.className = "exercise";

      // Save data in dataset for easy editing later
      exercise.dataset.name = data.name;
      exercise.dataset.startWeight = data.startWeight;
      exercise.dataset.goalWeight = data.goalWeight;
      exercise.dataset.currentWeight = data.currentWeight;
      exercise.dataset.reps = data.reps.join(',');
      exercise.dataset.repRangeMin = data.repRangeMin;
      exercise.dataset.repRangeMax = data.repRangeMax;
      exercise.dataset.increment = data.increment;

      exercise.innerHTML = `
        <strong>${data.name}</strong><br />
        ${data.currentWeight.toFixed(1)} kg × [${data.reps.join(", ")} reps]<br />
        Progress: ${progressPercent.toFixed(1)}%
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%"></div>
        </div>
        <button class="burger-btn" aria-label="Options menu">&#x22EE;</button>
        <div class="menu">
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </div>
      `;

      // Setup burger menu toggle
      const burgerBtn = exercise.querySelector(".burger-btn");
      const menu = exercise.querySelector(".menu");

      burgerBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // prevent document click closing immediately
        closeAllMenus();
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      });

      // Edit button
      exercise.querySelector(".edit-btn").addEventListener("click", () => {
        loadExerciseToForm(exercise);
        menu.style.display = "none";
      });

      // Delete button
      exercise.querySelector(".delete-btn").addEventListener("click", () => {
        const user = firebase.auth.currentUser;
if (user) {
  const exerciseId = exercise.dataset.docId;
  await deleteDoc(doc(firebase.db, "users", user.uid, "exercises", exerciseId));
}
exercise.remove();
updateOverallProgress();

      });

      return exercise;
    }

    // Update the inner content of an existing exercise element
   function updateExerciseElement(element, data, progressPercent) {
  element.innerHTML = `
    <strong>${data.name}</strong><br>
    ${data.currentWeight} kg × [${data.reps.join(', ')} reps]<br>
    Progress: ${progressPercent.toFixed(1)}%
    <div class="progress-bar">
      <div class="progress-fill" style="width: ${progressPercent}%"></div>
    </div>
    <div class="burger-menu">
      <button class="edit-btn">✏️</button>
      <button class="delete-btn">🗑️</button>
    </div>
  `;

  // Re-attach the edit and delete button handlers
  element.querySelector('.edit-btn').addEventListener('click', () => {
    populateFormFromElement(element);
    editingExercise = element;
    document.querySelector('button[type="submit"]').textContent = 'Update Exercise';
  });

  element.querySelector('.delete-btn').addEventListener('click', () => {
    element.remove();
    updateOverallProgress();
  });

  updateOverallProgress(); // Also refresh the average bar
}

    // Load exercise data from element to form for editing
    function loadExerciseToForm(exercise) {
      form.name.value = exercise.dataset.name;
      form.startWeight.value = exercise.dataset.startWeight;
      form.goalWeight.value = exercise.dataset.goalWeight;
      form.currentWeight.value = exercise.dataset.currentWeight;

      const repsArr = exercise.dataset.reps.split(",");
      form.reps1.value = repsArr[0];
      form.reps2.value = repsArr[1];
      form.reps3.value = repsArr[2];

      form.repRangeMin.value = exercise.dataset.repRangeMin;
      form.repRangeMax.value = exercise.dataset.repRangeMax;
      form.increment.value = exercise.dataset.increment;

      editingExercise = exercise;
      submitBtn.textContent = "Update Exercise";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Close all open menus when clicking outside
    document.addEventListener("click", () => {
      closeAllMenus();
    });

    function closeAllMenus() {
      document.querySelectorAll(".menu").forEach((menu) => {
        menu.style.display = "none";
      });
    }
  </script>
</body>
</html>
